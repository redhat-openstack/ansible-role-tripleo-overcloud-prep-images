#!/bin/bash

set -eux

### --start_docs
## Prepare the undercloud for deploying the overcloud
## ==================================================

## Prepare Your Environment
## ------------------------

## * Source in the undercloud credentials.
## ::

source {{ working_dir }}/stackrc

## * Upload images to glance.
## ::

openstack overcloud image upload {% if bash_deploy_ramdisk %}--old-deploy-image{% endif %}

## * Register nodes with Ironic.
## ::

openstack baremetal import --json instackenv.json
openstack baremetal configure boot

{% if step_introspect %}

## * Introspect hardware attributes of nodes.
## ::

#set to manageable
for node in `ironic node-list | grep available | awk '{print $2}'`; do
  ironic node-set-provision-state $node manage
done

#kick off introspection
for node in `ironic node-list | grep manage | awk '{print $2}'`; do
  openstack baremetal introspection start $node
  sleep 5m
done

#wait for all nodes to be off
set +e
ironic node-list | grep -q "power on"
while [[ $? -eq 0 ]]; do
 ironic node-list | grep -q "power on"
done
set -e

#set to available
for node in `ironic node-list | grep available | awk '{print $2}'`; do
  ironic node-set-provision-state $node provide
done

{% endif %}

### --stop_docs
