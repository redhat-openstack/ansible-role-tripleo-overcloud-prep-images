#!/bin/bash

set -eux

### --start_docs
## Prepare the undercloud for deploying the overcloud
## ==================================================

## Prepare Your Environment
## ------------------------

## * Source in the undercloud credentials.
## ::

source {{ working_dir }}/stackrc

## * Upload images to glance.
## ::

openstack overcloud image upload {% if bash_deploy_ramdisk %}--old-deploy-image{% endif %}

## * Register nodes with Ironic.
## ::

openstack baremetal import --json instackenv.json
openstack baremetal configure boot

{% if step_introspect %}

## * Introspect hardware attributes of nodes.
## ::

#set to manageable
for node in `ironic node-list | awk '/available/ {print $2}'`; do
  ironic node-set-provision-state $node manage
done

#start introspection
for node in `ironic node-list | awk '/available/ {print $2}'`; do
  openstack baremetal introspection start $node
  sleep 30s
done

#wait for all nodes to be off
set +e
while true; do
 ironic node-list | grep -q "power on" && break
 sleep 10s
done
set -e

#set to available
for node in `ironic node-list | awk '/manage/ {print $2}'`; do
  ironic node-set-provision-state $node provide
done

{% endif %}

### --stop_docs
