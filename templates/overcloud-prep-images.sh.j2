#!/bin/bash

set -eux

### --start_docs
## Prepare the undercloud for deploying the overcloud
## ==================================================

## Prepare Your Environment
## ------------------------

## * Introspect all manageable nodes with a caller provided timeout.
##   then move all nodes that power off after a successful introspection
##   back to available so we don't introspect them again.
## ::

introspect()
{
  for node in `ironic node-list | awk '/manage/ {print $2}'`; do
    openstack baremetal introspection start $node
    sleep 30s
  done

  timeout $1 bash -c -- 'source $HOME/stackrc; \
                         while [ $? -eq 0 ]; do \
                            sleep 10s; \
                            ironic node-list | grep -q "power on"; \
                         done'

  for node in `ironic node-list | awk '/manage/' | awk '/power off/ {print $2}'`; do
    ironic node-set-provision-state $node provide
  done
}


## * Source in the undercloud credentials.
## ::

source {{ working_dir }}/stackrc

## * Upload images to glance.
## ::

openstack overcloud image upload {% if bash_deploy_ramdisk %}--old-deploy-image{% endif %}

## * Register nodes with Ironic.
## ::

openstack baremetal import --json instackenv.json
openstack baremetal configure boot

{% if step_introspect %}

## * Introspect hardware attributes of nodes.
## ::

for node in `ironic node-list | awk '/available/ {print $2}'`; do
  ironic node-set-provision-state $node manage
done

introspect 15m
introspect 30m
introspect 60m


{% endif %}

### --stop_docs
